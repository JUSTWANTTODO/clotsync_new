<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - ClotSync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%); }
        .main-content { background-color: #f8f9fa; min-height: 100vh; }
        .request-card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
        .request-card:hover { transform: translateY(-5px); }
        .urgent-request { border-left: 4px solid #dc3545; background-color: #f8d7da; }
        .normal-request { border-left: 4px solid #28a745; background-color: #d4edda; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-4 text-white">
                    <h4><i class="fas fa-heartbeat me-2"></i>ClotSync</h4>
                    <hr class="text-white">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="#dashboard" data-bs-toggle="tab">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#request" data-bs-toggle="tab">
                                <i class="fas fa-plus-circle me-2"></i>Request Blood
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#history" data-bs-toggle="tab">
                                <i class="fas fa-history me-2"></i>Request History
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-white" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2>Welcome, {{ patient.name }}</h2>
                            <p class="text-muted">{{ patient.location }} • Blood Group: {{ patient.blood_group }}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning">Patient ID: {{ patient.id }}</span>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card request-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Quick Blood Request</h5>
                                            <form id="quickRequestForm">
                                                <div class="mb-3">
                                                    <label class="form-label">Blood Group</label>
                                                    <select class="form-select" id="quickBloodGroup" required>
                                                        <option value="">Select Blood Group</option>
                                                        <option value="A+">A+</option><option value="A-">A-</option>
                                                        <option value="B+">B+</option><option value="B-">B-</option>
                                                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                                                        <option value="O+">O+</option><option value="O-">O-</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Urgency</label>
                                                    <select class="form-select" id="quickUrgency" required>
                                                        <option value="normal">Normal</option>
                                                        <option value="urgent">Urgent</option>
                                                        <option value="emergency">Emergency</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Units Needed</label>
                                                    <input type="number" class="form-control" id="quickUnits" value="1" min="1" required>
                                                </div>
                                                <div class="d-grid">
                                                    <button type="submit" class="btn btn-warning">Request Blood Now</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card request-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Available Resources For Your Latest Request</h5>
                                            <div id="resourcesPanel">
                                                <p class="text-muted mb-2">We match nearby donors and hospitals that can help.</p>
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border text-warning me-2" role="status" style="display:none" id="resourcesLoading">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="loadPatientResources()">
                                                        <i class="fas fa-sync-alt me-1"></i> Refresh Resources
                                                    </button>
                                                </div>
                                                <hr>
                                                <div id="resourcesContent"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Request Tab -->
                        <div class="tab-pane fade" id="request">
                            <div class="card request-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Request Blood</h5>
                                </div>
                                <div class="card-body">
                                    <form id="bloodRequestForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Blood Group</label>
                                                <select class="form-select" id="requestBloodGroup" required>
                                                    <option value="">Select Blood Group</option>
                                                    <option value="A+">A+</option><option value="A-">A-</option>
                                                    <option value="B+">B+</option><option value="B-">B-</option>
                                                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                                                    <option value="O+">O+</option><option value="O-">O-</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Urgency Level</label>
                                                <select class="form-select" id="requestUrgency" required>
                                                    <option value="normal">Normal</option>
                                                    <option value="urgent">Urgent</option>
                                                    <option value="emergency">Emergency</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Units Needed</label>
                                                <input type="number" class="form-control" id="requestUnits" value="1" min="1" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Additional Notes</label>
                                                <textarea class="form-control" id="requestNotes" rows="3" placeholder="Any additional information..."></textarea>
                                            </div>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-warning btn-lg">Submit Blood Request</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div class="tab-pane fade" id="history">
                            <div class="card request-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Request History</h5>
                                </div>
                                <div class="card-body">
                                    <div id="requestHistory">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadRecentActivity();
            loadRequestHistory();
            loadPatientResources();
        });

        // Quick request form
        document.getElementById('quickRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBloodRequest('quick');
        });

        // Full request form
        document.getElementById('bloodRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitBloodRequest('full');
        });

        function submitBloodRequest(type) {
            let formData = {};
            
            if (type === 'quick') {
                formData = {
                    blood_group: document.getElementById('quickBloodGroup').value,
                    urgency: document.getElementById('quickUrgency').value,
                    units_needed: parseInt(document.getElementById('quickUnits').value)
                };
            } else {
                formData = {
                    blood_group: document.getElementById('requestBloodGroup').value,
                    urgency: document.getElementById('requestUrgency').value,
                    units_needed: parseInt(document.getElementById('requestUnits').value)
                };
            }

            fetch('/request_blood', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Blood request submitted successfully! Donors will be notified.');
                    if (type === 'quick') {
                        document.getElementById('quickRequestForm').reset();
                    } else {
                        document.getElementById('bloodRequestForm').reset();
                    }
                    loadRecentActivity();
                    loadRequestHistory();
                } else {
                    alert('Request failed. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Request failed. Please try again.');
            });
        }

        function loadRecentActivity() {
            // Mock data - in real app, this would fetch from API
            const recentActivity = [
                { type: 'request', message: 'Blood request submitted for O-', time: '2 hours ago' },
                { type: 'donor', message: 'Donor Sarah Johnson responded to your request', time: '1 hour ago' },
                { type: 'hospital', message: 'City General Hospital has O- blood available', time: '30 minutes ago' }
            ];

            const container = document.getElementById('recentActivity');
            let html = '';
            recentActivity.forEach(activity => {
                const icon = activity.type === 'request' ? 'fas fa-plus-circle text-warning' : 
                           activity.type === 'donor' ? 'fas fa-user-plus text-success' : 
                           'fas fa-hospital text-primary';
                html += `
                    <div class="d-flex align-items-center mb-3">
                        <i class="${icon} me-3"></i>
                        <div>
                            <p class="mb-0">${activity.message}</p>
                            <small class="text-muted">${activity.time}</small>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function loadRequestHistory() {
            // Mock data - in real app, this would fetch from API
            const history = [
                { id: 1, blood_group: 'O-', urgency: 'emergency', status: 'fulfilled', date: '2024-01-15', units: 2 },
                { id: 2, blood_group: 'A+', urgency: 'normal', status: 'pending', date: '2024-01-14', units: 1 },
                { id: 3, blood_group: 'B+', urgency: 'urgent', status: 'fulfilled', date: '2024-01-10', units: 3 }
            ];

            const container = document.getElementById('requestHistory');
            let html = '';
            history.forEach(request => {
                const statusClass = request.status === 'fulfilled' ? 'text-success' : 'text-warning';
                const urgencyClass = request.urgency === 'emergency' ? 'urgent-request' : 'normal-request';
                html += `
                    <div class="card mb-3 ${urgencyClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Request #${request.id}</h6>
                                    <p class="card-text">
                                        <strong>Blood Group:</strong> ${request.blood_group}<br>
                                        <strong>Urgency:</strong> ${request.urgency}<br>
                                        <strong>Units:</strong> ${request.units}<br>
                                        <strong>Date:</strong> ${request.date}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge ${statusClass}">${request.status}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function loadPatientResources() {
            const loading = document.getElementById('resourcesLoading');
            const container = document.getElementById('resourcesContent');
            if (!loading || !container) return;
            loading.style.display = 'inline-block';
            container.innerHTML = '';
            try {
                const resp = await fetch('/api/patient/resources');
                const data = await resp.json();
                loading.style.display = 'none';
                if (!data.request) {
                    container.innerHTML = '<div class="alert alert-info">You have no pending requests. Submit a new request to see available donors and hospitals.</div>';
                    return;
                }
                let html = '';
                html += `
                    <div class="mb-3">
                        <h6 class="mb-1">Your Request</h6>
                        <div class="small text-muted">Blood Group: <span class="badge bg-danger">${data.request.blood_group}</span> • Units: <span class="badge bg-secondary">${data.request.units_needed}</span> • Urgency: <span class="badge bg-warning text-dark">${data.request.urgency}</span></div>
                    </div>
                `;
                // Hospitals
                html += '<h6 class="mt-3"><i class="fas fa-hospital me-2"></i>Hospitals With Stock</h6>';
                if (data.hospitals.length === 0) {
                    html += '<p class="text-muted">No hospitals with available stock found nearby.</p>';
                } else {
                    html += '<div class="list-group mb-3">';
                    data.hospitals.forEach(h => {
                        const fulfill = h.can_fulfill ? '<span class="badge bg-success ms-2">Can fulfill</span>' : '';
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong>${h.name}</strong> ${fulfill}<br>
                                                <small class="text-muted">${h.location}</small>
                                            </div>
                                            <div class="text-end">
                                                <div><span class="badge bg-primary">${h.units_available} units</span></div>
                                                <small class="text-muted">${h.distance_text}</small>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-phone me-1"></i>Contact: <strong>${h.contact || 'Not available'}</strong>
                                            </small>
                                        </div>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" 
                                                   placeholder="Additional info (e.g., 'I got 2 units, need 2 more')" 
                                                   id="hospital_note_${h.id}">
                                        </div>
                                        <button class="btn btn-sm btn-success" onclick="sendRequestToHospital(${h.id}, '${h.name}', ${h.units_available})">
                                            <i class="fas fa-paper-plane me-1"></i>Request from Hospital
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                // Donors
                html += '<h6 class="mt-3"><i class="fas fa-user-friends me-2"></i>Matching Donors</h6>';
                if (data.donors.length === 0) {
                    html += '<p class="text-muted">No matching donors available right now.</p>';
                } else {
                    html += '<div class="list-group">';
                    data.donors.slice(0, 10).forEach(d => {
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong>${d.name}</strong> <span class="badge bg-danger ms-2">${d.blood_group}</span><br>
                                                <small class="text-muted">${d.location} • donations: ${d.donations_count}</small>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">${d.distance_text}</small>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-phone me-1"></i>Contact: <strong>${d.contact || 'Not available'}</strong>
                                            </small>
                                        </div>
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" 
                                                   placeholder="Additional info (e.g., 'I got 2 units, need 2 more')" 
                                                   id="donor_note_${d.id}">
                                        </div>
                                        <button class="btn btn-sm btn-warning" onclick="sendRequestToDonor(${d.id}, '${d.name}', '${d.blood_group}')">
                                            <i class="fas fa-paper-plane me-1"></i>Request from Donor
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                container.innerHTML = html;
            } catch (e) {
                loading.style.display = 'none';
                container.innerHTML = '<div class="alert alert-danger">Failed to load available resources. Please try again.</div>';
            }
        }

        function sendRequestToHospital(hospitalId, hospitalName, unitsAvailable) {
            const note = document.getElementById(`hospital_note_${hospitalId}`).value;
            const requestData = {
                hospital_id: hospitalId,
                message: note || `Patient ${current_user.name} is requesting blood from your hospital.`
            };
            
            fetch('/api/patient/request-hospital', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Request sent to ${hospitalName}! They will contact you soon.`);
                    loadPatientResources(); // Refresh the resources
                } else {
                    alert('Failed to send request. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send request. Please try again.');
            });
        }

        function sendRequestToDonor(donorId, donorName, bloodGroup) {
            const note = document.getElementById(`donor_note_${donorId}`).value;
            const requestData = {
                donor_id: donorId,
                message: note || `Patient ${current_user.name} is requesting ${bloodGroup} blood donation.`
            };
            
            fetch('/api/patient/request-donor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Request sent to ${donorName}! They will contact you soon.`);
                    loadPatientResources(); // Refresh the resources
                } else {
                    alert('Failed to send request. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send request. Please try again.');
            });
        }
    </script>
</body>
</html>

