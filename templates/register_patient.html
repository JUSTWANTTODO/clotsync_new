<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration - ClotSync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section { background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%); color: white; padding: 80px 0; }
        .feature-card { transition: transform 0.3s ease; border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .feature-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-warning">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-heartbeat text-white me-2"></i>ClotSync</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/patient_portal">Portal</a>
                <a class="nav-link" href="/">Home</a>
            </div>
        </div>
    </nav>

    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-4"><i class="fas fa-user-injured me-3"></i>Patient Registration</h1>
            <p class="lead mb-4">Request Blood When You Need It Most</p>
        </div>
    </section>

    <section class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card feature-card">
                        <div class="card-header bg-warning text-dark">
                            <h4 class="mb-0"><i class="fas fa-user-plus me-2"></i>Register as Patient</h4>
                        </div>
                        <div class="card-body">
                            <form id="patientRegistrationForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="patientName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Blood Group</label>
                                        <select class="form-select" id="patientBloodGroup" required>
                                            <option value="">Select Blood Group</option>
                                            <option value="A Negative">A Negative</option>
                                            <option value="A Positive">A Positive</option>
                                            <option value="B Positive">B Positive</option>
                                            <option value="A1 Positive">A1 Positive</option>
                                            <option value="A1B Positive">A1B Positive</option>
                                            <option value="A2 Negative">A2 Negative</option>
                                            <option value="A2B Negative">A2B Negative</option>
                                            <option value="A2B Positive">A2B Positive</option>
                                            <option value="AB Positive">AB Positive</option>
                                            <option value="B Negative">B Negative</option>
                                            <option value="Bombay Blood Group">Bombay Blood Group</option>
                                            <option value="O Negative">O Negative</option>
                                            <option value="O Positive">O Positive</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Number of Units Needed</label>
                                        <input type="number" class="form-control" id="unitsNeeded" min="1" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Required By (Date)</label>
                                        <input type="date" class="form-control" id="requiredBy">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-select" id="patientGender">
                                            <option value="">Select</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Age</label>
                                        <input type="number" class="form-control" id="patientAge" min="0" max="120">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Medical Problem</label>
                                        <input type="text" class="form-control" id="patientProblem" placeholder="e.g., Bypass surgery (Heart)">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Hospital</label>
                                        <select class="form-select" id="patientHospital">
                                            <option value="">Select Hospital</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="patientLocation" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">District</label>
                                        <input type="text" class="form-control" id="patientDistrict">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">State</label>
                                        <input type="text" class="form-control" id="patientState">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Contact Name</label>
                                        <input type="text" class="form-control" id="contactName" placeholder="e.g., Srujana">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Contact Number</label>
                                        <input type="tel" class="form-control" id="patientContact" required placeholder="e.g., 8185861631">
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-warning btn-lg">Submit Blood Request</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p>&copy; 2024 ClotSync. We're here to help when you need it most.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('patientRegistrationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // No-login flow: create or upsert a patient behind the scenes, then create a blood request
            const rawHospitalId = document.getElementById('patientHospital').value;
            const hospitalId = rawHospitalId ? parseInt(rawHospitalId) : null;

            const payload = {
                name: document.getElementById('patientName').value,
                blood_group: document.getElementById('patientBloodGroup').value,
                units_needed: parseInt(document.getElementById('unitsNeeded').value || '1'),
                requested_date_text: document.getElementById('requiredBy').value,
                location: document.getElementById('patientLocation').value,
                contact: document.getElementById('patientContact').value,
                gender: document.getElementById('patientGender').value,
                age: parseInt(document.getElementById('patientAge').value || '0'),
                problem: document.getElementById('patientProblem').value,
                district: document.getElementById('patientDistrict').value,
                state: document.getElementById('patientState').value,
                hospital_id: hospitalId,
                contact_name: document.getElementById('contactName').value,
                contact_phone: document.getElementById('patientContact').value
            };

            // Call a dedicated endpoint that implements the no-login patient submission
            fetch('/patient_request_submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(async r => {
                let data;
                try { data = await r.json(); } catch (_) { data = {}; }
                if (r.ok && data.success) {
                    alert('Your blood request has been submitted successfully. Your request code is ' + data.request_code);
                    window.location.href = '/';
                } else {
                    if (data.error && data.error.includes('already submitted')) {
                        // Show detailed message for duplicate request
                        const message = `Request Already Submitted!\n\n` +
                            `You have already submitted a blood request today.\n\n` +
                            `Existing Request Code: ${data.existing_request_code}\n` +
                            `Submitted: ${data.existing_request_time}\n\n` +
                            `Please wait until tomorrow to submit another request.`;
                        alert(message);
                    } else {
                        const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : 'Could not submit request. Please ensure all fields are valid.';
                        alert(errMsg);
                    }
                }
            })
            .catch((e) => {
                console.error('Submit error', e);
                alert('Could not submit request. Please try again.');
            });
        });
    </script>
    <script>
        // Load hospitals for dropdown
        fetch('/api/hospitals')
          .then(r => r.json())
          .then(data => {
            const sel = document.getElementById('patientHospital');
            if (!sel || !data.hospitals) return;
            data.hospitals.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.id;
                opt.textContent = `${h.name} — ${h.location}`;
                sel.appendChild(opt);
            });
          })
          .catch(() => {});
    </script>
</body>
</html>

